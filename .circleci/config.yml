version: 2.1
variables: &variables
    docker:
      - image: microsoft/dotnet:2.2-sdk
    environment: 
        - SOLUTION: "alma-infrastructure.sln"
        - CONFIGURATION: "Release"

        - MSBUILD: "15.0"
        - VISUALSTUDIO: "15.0"
        - VERBOSITY: "minimal"

        - PUBLISHDBPROJ: ""
        - PUBLISHPROJ: ""
        - DEVELOPMENTPROFILE: ""
        - STAGINGPROFILE: ""
        - STAGINGPASSWORD: ""
        - PRODUCTIONPROFILE: ""

        - NUGETREPOSITORY: "https://dev.almasistemas.com.br/nuget/alma"

        - AUTHORS: "Marcos Junior and Alex Duraes"
        - COMPANY: "Marcos Junior and Alex Duraes"
        - PRODUCT: "Common Infrastructure"
        - COPYRIGHT: "Copyright (c) Marcos Junior and Alex Duraes"

        - ICON_URL: "https://avatars2.githubusercontent.com/u/46223903?s:200&v:4"
        - PROJECT_URL: "https://github.com/alma-sys"
        - REPOSITORY_URL: "https://github.com/alma-sys/alma-infra"
        - BUILDACTION: "Clean,Build"

               
jobs:
  build:
    <<: *variables
    steps:
      - checkout
      - restore_cache:
          key: cache-{{ .Environment.CIRCLE_WORKFLOW_ID }}
      - run:
          name: Nuget Restore
          command: dotnet restore
      - run:
          name: Build
          command: |
              PACKVERSION=3.`date -u +%y.%m%d.%H%M`;
              if [[ $CIRCLE_BRANCH == *"beta"* ]]; then 
                  VERSIONINFO="-beta"; 
              fi
              echo "Version=$PACKVERSION$VERSIONINFO";
              dotnet msbuild "$SOLUTION" -t:$BUILDACTION -tv:$MSBUILD -verbosity:$VERBOSITY -p:Configuration=$CONFIGURATION -p:VisualStudioVersion=$VISUALSTUDIO -p:Version=$PACKVERSION$VERSIONINFO -p:AssemblyVersion=$PACKVERSION -property:Authors="$AUTHORS" -property:Company="$COMPANY" -property:Product="$PRODUCT" -property:Copyright="$COPYRIGHT" -property:PROJECT_URL="$PROJECT_URL" -property:ICON_URL="$ICON_URL" -property:GeneratePackageOnBuild=true
      - save_cache:
          key: cache-{{ .Environment.CIRCLE_WORKFLOW_ID }}
          paths:
            - ./**/node_modules
            - ./**/bin
            - ./**/obj
      - store_artifacts:
          path: ./**/bin/**
          prefix: binaries

  test:
    <<: *variables
    steps:
      - restore_cache:
          key: cache-{{ .Environment.CIRCLE_WORKFLOW_ID }}
      - run:
          name: Test
          command: |
            shopt -s globstar && for i in **/bin/$CONFIGURATION/**/*Tests*.dll; do # Whitespace-safe and recursive
                echo "Testing '$i'..."
                dotnet vstest "$i"
            done
      - store_test_results:
          path: ./**/*.trx
          prefix: tests
      - store_test_results:
          path: ./**/*.htm*
          prefix: tests

  deploy:
    <<: *variables
    steps:
      - restore_cache:
          key: cache-{{ .Environment.CIRCLE_WORKFLOW_ID }}
      - deploy:
          name: Deploy
          command: |
            shopt -s globstar && for i in **/bin/$CONFIGURATION/**/*.nupkg; do # Whitespace-safe and recursive
                nuget push -ApiKey $NUGETAPIKEY -Source $NUGETREPOSITORY "$i"
            done
      - store_artifacts:
          path: ./**/*.nupkg
          prefix: packages

workflows:
  version: 2
  Build:
    jobs:
      - build
      - test:
          requires:
            - build
      - deploy:
            requires:
                - test
            filters:
                branches:
                    only: master